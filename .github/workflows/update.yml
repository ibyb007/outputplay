name: Update Filtered & Categorized JTV M3U → Private Gist

on:
  schedule:
    - cron: '0 4 * * *'           # daily

  workflow_dispatch:

jobs:
  generate-and-update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Generate filtered & categorized jtv.m3u → Gist
        env:
          SOURCE_URL: ${{ secrets.SOURCE_URL }}
          GIST_TOKEN: ${{ secrets.GIST_TOKEN }}
          GIST_ID:    ${{ secrets.GIST_ID }}
        run: |
          python3 - << 'EOF'
          import requests
          import os
          from datetime import datetime

          SOURCE_URL = os.getenv("SOURCE_URL")
          GIST_TOKEN = os.getenv("GIST_TOKEN")
          GIST_ID    = os.getenv("GIST_ID")
          OUTPUT_FILE_NAME = "jtv.m3u"
          USER_AGENT = "plaYtv/7.1.3 (Linux;Android 13) ygx/824.1 ExoPlayerLib/824.0"

          if not all([SOURCE_URL, GIST_TOKEN, GIST_ID]):
              print("Missing secrets")
              exit(1)

          # Fetch JSON
          resp = requests.get(SOURCE_URL, timeout=20)
          resp.raise_for_status()
          data = resp.json()
          channels = data if isinstance(data, list) else data.get("channels", []) or []

          # Exclusion keywords (case-insensitive)
          exclude_patterns = [
              "tamil", "sun", "vijay", "kalaignar", "raj", "telugu", "gemini", "etv", "maa", "zeetelugu",
              "kannada", "colorskannada", "sudeep", "udaya", "suvarna", "gujarati", "sabgujarati",
              "malayalam", "mazhavil", "surya", "punjabi", "ptc", "mh1", "ziyara",
              "educational", "gyan", "gyandarshan", "vedanta", "devotional", "sadhguru", "astrology",
              "bhakti", "santvani", "divya", "iskcon", "shri", "ramayan", "mahadev"
          ]

          # Category mapping functions (based on PDF structure)
          def get_category(name):
              name_lower = name.lower()
              if any(kw in name_lower for kw in ["star", "colors", "sony", "zee", "sab", "&tv", "big magic", "rishtey", "shemaroo", "dangal", "bollywood", "cineplex", "max", "gold"]):
                  return "Hindi Entertainment & Movies"
              if any(kw in name_lower for kw in ["aaj tak", "abp", "india today", "news18", "republic", "ndtv", "times now", "zee news", "bharat", "sudarshan", "tv9"]):
                  return "Hindi News"
              if any(kw in name_lower for kw in ["sports", "star sports", "sony six", "ten", "willow", "espn", "sports18", "cricket", "football", "jiofootball"]):
                  return "Sports"
              if any(kw in name_lower for kw in ["discovery", "nat geo", "history", "animal planet", "travelxp", "fox life"]):
                  return "Infotainment / Lifestyle"
              if any(kw in name_lower for kw in ["bbc", "cnn", "bloomberg", "cnbc", "fox", "al jazeera", "english"]):
                  return "English / International"
              if "music" in name_lower or "mtv" in name_lower or "9xm" in name_lower:
                  return "Music"
              return "Others / General"

          # Build M3U with categories as group-title
          lines = [
              "#EXTM3U",
              f"# Generated {datetime.utcnow().strftime('%Y-%m-%d %H:%M UTC')} from {SOURCE_URL}",
              "# Filtered: excluded Tamil/Telugu/Kannada/Gujarati/Malayalam/Punjabi/Educational/Devotional",
              "# Categorized per Jio channel guide patterns"
          ]

          shared_cookie = None
          processed_count = 0

          for ch in channels:
              name = ch.get("name") or ch.get("title") or "Unknown"
              name_lower = name.lower()

              # Skip excluded channels
              if any(pat in name_lower for pat in exclude_patterns):
                  continue

              logo   = ch.get("logo", "")
              link   = ch.get("link") or ch.get("url") or ch.get("stream") or ""
              drm    = ch.get("drmLicense") or ""
              cookie = ch.get("cookie") or ""

              if not link or not drm or ":" not in drm:
                  continue

              if cookie and not shared_cookie:
                  shared_cookie = cookie
              cookie = shared_cookie or cookie
              if not cookie:
                  continue

              kid, key = drm.split(':', 1)
              kid = kid.strip().replace('-', '')
              key = key.strip().replace('-', '')
              if len(kid) != 32 or len(key) != 32:
                  continue

              token_part = cookie.split("=", 1)[1] if "=" in cookie else ""

              category = get_category(name)

              lines.extend([
                  f'#EXTINF:-1 tvg-id="{name.replace(" ", "_")}" group-title="{category}" tvg-logo="{logo}",{name}',
                  "#KODIPROP:inputstream.adaptive.license_type=clearkey",
                  f"#KODIPROP:inputstream.adaptive.license_key=https://aqfadtv.xyz/clearkey/results.php?keyid={kid}&key={key}",
                  f"#EXTVLCOPT:http-user-agent={USER_AGENT}",
                  f'#EXTHTTP:{{"cookie":"{cookie}"}}',
                  f"{link}?__hdnea__={token_part}",
                  ""
              ])
              processed_count += 1

          if processed_count == 0:
              print("No channels after filtering")
              exit(1)

          m3u_content = "\n".join(lines)

          # Upload to private Gist
          headers = {
              "Authorization": f"token {GIST_TOKEN}",
              "Accept": "application/vnd.github+json"
          }
          payload = {
              "files": {
                  OUTPUT_FILE_NAME: {"content": m3u_content}
              }
          }
          url = f"https://api.github.com/gists/{GIST_ID}"
          r = requests.patch(url, headers=headers, json=payload)

          if r.status_code == 200:
              raw = f"https://gist.githubusercontent.com/raw/{GIST_ID}/{OUTPUT_FILE_NAME}"
              print(f"Success! Updated Gist. Raw URL: {raw}")
              print(f"Channels after filter: {processed_count}")
          else:
              print(f"Gist update failed ({r.status_code}): {r.text}")
              exit(1)
          EOF

      - name: Log result
        run: echo "Workflow finished"
