name: Update JTV M3U â†’ Private Gist

on:
  schedule:
    - cron: '0 4 * * *'           # daily \~09:30 IST

  workflow_dispatch:              # manual run from Actions tab

jobs:
  generate-and-update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Generate jtv.m3u and update private Gist
        env:
          SOURCE_URL: ${{ secrets.SOURCE_URL }}
          GIST_TOKEN: ${{ secrets.GIST_TOKEN }}
          GIST_ID:    ${{ secrets.GIST_ID }}
        run: |
          python3 - << 'EOF'
          import requests
          import json
          import os
          from datetime import datetime

          SOURCE_URL = os.getenv("SOURCE_URL")
          GIST_TOKEN = os.getenv("GIST_TOKEN")
          GIST_ID    = os.getenv("GIST_ID")
          OUTPUT_FILE_NAME = "jtv.m3u"
          USER_AGENT = "plaYtv/7.1.3 (Linux;Android 13) ygx/824.1 ExoPlayerLib/824.0"

          if not all([SOURCE_URL, GIST_TOKEN, GIST_ID]):
              print("Missing required secrets: SOURCE_URL, GIST_TOKEN or GIST_ID")
              exit(1)

          print(f"Fetching channels from: {SOURCE_URL}")
          try:
              resp = requests.get(SOURCE_URL, timeout=20)
              resp.raise_for_status()
              data = resp.json()
              channels = data if isinstance(data, list) else data.get("channels", []) or data.get("data", []) or []
          except Exception as e:
              print(f"Fetch/parse error: {e}")
              exit(1)

          if not channels:
              print("No channels found")
              exit(1)

          lines = [
              "#EXTM3U",
              f"# Generated {datetime.utcnow().strftime('%Y-%m-%d %H:%M UTC')} from {SOURCE_URL}",
              "# Full list - no category filters"
          ]

          shared_cookie = None

          for ch in channels:
              name   = ch.get("name") or ch.get("title") or "Unknown"
              logo   = ch.get("logo", "")
              link   = ch.get("link") or ch.get("url") or ch.get("stream") or ""
              drm    = ch.get("drmLicense") or ""
              cookie = ch.get("cookie") or ""

              if not link or not drm:
                  continue

              if cookie and not shared_cookie:
                  shared_cookie = cookie
              cookie = shared_cookie or cookie
              if not cookie:
                  continue

              if ':' not in drm:
                  continue
              kid, key = drm.split(':', 1)
              kid = kid.strip().replace('-', '')
              key = key.strip().replace('-', '')
              if len(kid) != 32 or len(key) != 32:
                  continue

              token_part = cookie.split("=", 1)[1] if "=" in cookie else ""

              lines.extend([
                  f'#EXTINF:-1 tvg-id="{name.replace(" ", "_")}" group-title="JioTV" tvg-logo="{logo}",{name}',
                  "#KODIPROP:inputstream.adaptive.license_type=clearkey",
                  f"#KODIPROP:inputstream.adaptive.license_key=https://aqfadtv.xyz/clearkey/results.php?keyid={kid}&key={key}",
                  f"#EXTVLCOPT:http-user-agent={USER_AGENT}",
                  f'#EXTHTTP:{{"cookie":"{cookie}"}}',
                  f"{link}?__hdnea__={token_part}",
                  ""
              ])

          if len(lines) < 5:
              print("No valid channels processed")
              exit(1)

          m3u_content = "\n".join(lines)

          # Update Gist via GitHub API
          headers = {
              "Authorization": f"token {GIST_TOKEN}",
              "Accept": "application/vnd.github+json",
              "X-GitHub-Api-Version": "2022-11-28"
          }

          payload = {
              "files": {
                  OUTPUT_FILE_NAME: {
                      "content": m3u_content
                  }
              }
          }

          url = f"https://api.github.com/gists/{GIST_ID}"
          print(f"Updating Gist: {url}")

          r = requests.patch(url, headers=headers, json=payload)
          if r.status_code == 200:
              print("Gist updated successfully")
              raw_url = f"https://gist.githubusercontent.com/raw/{GIST_ID}/{OUTPUT_FILE_NAME}"
              print(f"Raw URL: {raw_url}")
          else:
              print(f"Failed to update Gist: {r.status_code}")
              print(r.text)
              exit(1)
          EOF

      # Optional: commit log message if you want traceability (no file commit needed)
      - name: Log completion
        run: echo "Workflow completed - jtv.m3u updated in private Gist"
